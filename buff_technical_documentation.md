# RoboMaster 哨兵机器人 BUFF 自动瞄准系统技术文档

## 1. 系统概述

### 1.1 项目背景
BUFF自动瞄准系统是专门为RoboMaster机器人竞赛设计的计算机视觉瞄准系统，用于自动识别和追踪高速旋转的BUFF目标（大符和小符），实现精确打击。系统采用深度学习与传统图像处理相结合的方法，集成YOLOv11目标检测、扩展卡尔曼滤波预测、运动建模等先进技术。

### 1.2 系统特性
- **双模式支持**：小符（匀速圆周运动）和大符（变速圆周运动）
- **高精度检测**：YOLOv11神经网络+传统图像处理方法
- **实时预测**：扩展卡尔曼滤波器(EKF)进行状态估计
- **多目标处理**：支持多候选框检测与选择
- **鲁棒性强**：包含抗干扰、误差补偿、异常处理机制
- **跨平台支持**：适配哨兵、步兵、无人机等不同机器人平台

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   图像输入层     │───▶│   目标检测层     │───▶│   跟踪预测层     │
│                 │    │                 │    │                 │
│ - 图像预处理     │    │ - YOLOv11检测   │    │ - EKF状态估计   │
│ - 相机标定       │    │ - 传统图像处理   │    │ - 运动建模       │
│ - 数据输入       │    │ - 特征提取       │    │ - 轨迹预测       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   控制输出层     │◀───│   瞄准解算层     │◀───│   坐标转换层     │
│                 │    │                 │    │                 │
│ - 云台控制       │    │ - 弹道计算       │    │ - 坐标系转换     │
│ - 射击控制       │    │ - 角度解算       │    │ - 3D位置估计     │
│ - 安全保护       │    │ - 预测补偿       │    │ - 几何计算       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 模块划分

#### 2.2.1 核心算法模块
```
tasks/auto_buff/
├── buff_type.hpp/cpp        # 基础数据结构定义
├── buff_detector.hpp/cpp    # 目标检测器
├── yolo11_buff.hpp/cpp      # YOLOv11神经网络模块
├── buff_predict.hpp         # 运动预测算法
├── buff_target.hpp/cpp      # 目标跟踪器
├── buff_solver.hpp/cpp      # 坐标转换求解器
└── buff_aimer.hpp/cpp       # 瞄准控制算法
```

#### 2.2.2 模型文件
```
assets/
├── yolo11_buff_int8.xml     # YOLOv11模型配置文件
└── yolo11_buff_int8.bin     # YOLOv11模型权重文件
```

#### 2.2.3 配置文件
```
configs/
├── sentry.yaml               # 哨兵模式主配置
├── standard3.yaml            # 步兵模式配置
├── standard4.yaml            # 英雄模式配置
├── uav.yaml                  # 无人机模式配置
└── demo.yaml                 # 演示模式配置
```

#### 2.2.4 测试调试
```
tests/
└── auto_buff_test.cpp        # 综合性能测试

src/
├── auto_buff_debug.cpp       # 实时调试图像显示
└── auto_buff_debug_mpc.cpp   # MPC控制调试程序
```

## 3. 目标检测算法

### 3.1 YOLOv11深度学习检测

#### 3.1.1 模型架构
- **输入格式**: 640×640×3 RGB图像
- **输出格式**: [15, 8400]矩阵
  - 前4行: [cx, cy, ow, oh] - 边界框中心坐标和宽高
  - 第5行: 置信度score
  - 后10行: 5个关键点坐标 (x,y)

#### 3.1.2 预处理流程
```cpp
// Letterbox预处理，保持宽高比
factor = min(target_size/original_size)
padded_image = resize(original_image, factor)
padded_image = pad_to_square(padded_image)
```

#### 3.1.3 后处理算法
```cpp
// 坐标转换到原始图像
box.x = (cx - 0.5 * ow) * factor;
box.y = (cy - 0.5 * oh) * factor;
box.width = ow * factor;
box.height = oh * factor;
```

#### 3.1.4 多目标处理
- **NMS阈值**: 0.5
- **置信度阈值**: 0.8
- **最大检测数**: 8400

### 3.2 传统图像处理方法

#### 3.2.1 处理流程
```
原始图像 → 灰度转换 → 二值化 → 形态学膨胀 → 轮廓检测
```

#### 3.2.2 关键参数
- **二值化阈值**: 100-150（可调）
- **膨胀核大小**: 3×3
- **检测目标**: 扇叶边缘和中心R标志

#### 3.2.3 R中心计算
通过几何关系估算中心点位置：
```cpp
r_center = (point6 - point5) * 1.4 + point5;
```

## 4. 运动预测算法

### 4.1 小符预测模型（匀速圆周运动）

#### 4.1.1 数学模型
```
角度预测: θ(t+Δt) = θ(t) + ω × Δt
角速度: ω = π/3 rad/s (恒定)
```

#### 4.1.2 状态向量
```
X = [θ]  # 角度状态
```

#### 4.1.3 EKF参数
- **状态转移矩阵**: A = [1.0]
- **过程噪声**: Q = [0.0]
- **测量噪声**: R = [0.05]
- **控制输入**: B = ±π/3（根据旋转方向）

### 4.2 大符预测模型（变速圆周运动）

#### 4.2.1 数学模型
```
角速度: ω(t) = a × sin(ωt + φ) + (2.09 - a)
角度预测: θ(t+Δt) = θ(t) + ∫[t,t+Δt] ω(τ)dτ
```

#### 4.2.2 状态向量
```
X = [θ, ω, a, ω₀, φ]ᵀ
参数说明:
θ: 目标角度
ω: 瞬时角速度
a: 正弦振幅 (0.78-1.045)
ω₀: 正弦频率 (1.884-2.000)
φ: 相位角
```

#### 4.2.3 非线性状态转移
```cpp
// 雅可比矩阵线性化
F = ∂f/∂x = [
  [1, 0, ∂θ/∂a, ∂θ/∂ω₀, ∂θ/∂φ],
  [0, 0, ∂ω/∂a, ∂ω/∂ω₀, ∂ω/∂φ],
  [0, 0, 1, 0, 0],
  [0, 0, 0, 1, 0],
  [0, 0, 0, 0, 1]
]
```

### 4.3 扩展卡尔曼滤波器

#### 4.3.1 预测步骤
```cpp
// 状态预测
x̂ₖ|ₖ₋₁ = f(x̂ₖ₋₁|ₖ₋₁, uₖ)
// 协方差预测
Pₖ|ₖ₋₁ = Fₖ Pₖ₋₁|ₖ₋₁ Fₖᵀ + Qₖ
```

#### 4.3.2 更新步骤
```cpp
// 卡尔曼增益
Kₖ = Pₖ|ₖ₋₁ Hₖᵀ (Hₖ Pₖ|ₖ₋₁ Hₖᵀ + Rₖ)⁻¹
// 状态更新
x̂ₖ|ₖ = x̂ₖ|ₖ₋₁ + Kₖ (zₖ - h(x̂ₖ|ₖ₋₁))
// 协方差更新
Pₖ|ₖ = (I - Kₖ Hₖ) Pₖ|ₖ₋₁ (I - Kₖ Hₖ)ᵀ + Kₖ Rₖ Kₖᵀ
```

#### 4.3.3 自适应噪声
- **NIS检测**: 新息标准化平方和
- **NEES检测**: 估计误差标准化平方和
- **卡方检验**: 95%置信水平，自由度=4
- **阈值**: 0.711

## 5. 坐标转换与几何计算

### 5.1 坐标系定义

#### 5.1.1 坐标系转换链
```
BUFF坐标系 → 相机坐标系 → 云台坐标系 → 世界坐标系
```

#### 5.1.2 旋转表示
- **四元数**: q = [w, x, y, z]
- **旋转矩阵**: R ∈ SO(3)
- **欧拉角**: [roll, pitch, yaw]

### 5.2 3D-2D投影

#### 5.2.1 相机模型
```cpp
// 透视投影
[u]   [fx  0  cx] [X/Z]
[v] = [0  fy  cy] [Y/Z]
[1]   [0   0   1] [1 ]
```

#### 5.2.2 PnP求解
使用OpenCV的`solvePnP`函数：
```cpp
cv::solvePnP(OBJECT_POINTS, image_points,
             camera_matrix, distort_coeffs,
             rvec, tvec, false, cv::SOLVEPNP_IPPE)
```

### 5.3 球坐标转换

#### 5.3.1 球坐标→笛卡尔坐标
```
x = r × cos(θ) × cos(φ)
y = r × cos(θ) × sin(φ)
z = r × sin(θ)
```

#### 5.3.2 雅可比矩阵
```cpp
J_sph2cart = ∂[x,y,z]/∂[r,θ,φ]
J_cart2sph = ∂[r,θ,φ]/∂[x,y,z]
```

## 6. 瞄准控制算法

### 6.1 弹道计算

#### 6.1.1 迭代瞄准算法
```
1. 预测目标当前位置 P₀
2. 计算弹道飞行时间 t₀ = f(P₀)
3. 重新预测 t₀ 时间后的位置 P₁
4. 检查时间误差 Δt = |t₁ - t₀|
5. 如果 Δt > 阈值，继续迭代
```

#### 6.1.2 弹道模型
使用抛物线运动方程：
```
x(t) = v₀ × cos(θ) × t
z(t) = v₀ × sin(θ) × t - 0.5 × g × t²
```

### 6.2 MPC控制

#### 6.2.1 状态预测
```cpp
// 速度预测
yaw_vel = limit_rad(yaw - last_yaw) / (2*dt)
pitch_vel = limit_rad(pitch - last_pitch) / (2*dt)

// 加速度预测
yaw_acc = (yaw_vel - last_yaw_vel) / dt
pitch_acc = (pitch_vel - last_pitch_vel) / dt
```

#### 6.2.2 约束处理
- **角度限制**: [-π, π]
- **速度限幅**: [-3, 3] rad/s
- **平滑滤波**: 滑动平均窗口

### 6.3 射击决策

#### 6.3.1 决策条件
```cpp
// 角度误差检查
if (abs(target_angle - current_angle) > ANGLE_THRESHOLD) {
    fire_enable = false;
}

// 目标切换保护
counter++;
if (counter < STABLE_FRAMES) {
    fire_enable = false;
}

// 预测置信度检查
if (confidence < CONFIDENCE_THRESHOLD) {
    fire_enable = false;
}
```

#### 6.3.2 射击间隔
- **最小间隔**: 0.1s
- **决策速度**: 10 rad/s
- **预测时间**: 0.1s

## 7. 性能指标

### 7.1 检测性能
- **检测精度**: > 95%
- **召回率**: > 90%
- **FPS**: ≥ 60
- **延迟**: < 50ms

### 7.2 跟踪性能
- **预测误差**: < 0.1 rad
- **收敛时间**: < 2s
- **稳定性**: σ < 0.05 rad
- **鲁棒性**: 能处理遮挡、光照变化

### 7.3 控制性能
- **角度精度**: ±0.01 rad
- **响应时间**: < 100ms
- **超调量**: < 5%
- **稳态误差**: < 0.005 rad

## 8. 配置参数

### 8.1 主配置文件（sentry.yaml）
```yaml
# 模型配置
model: assets/yolo11_buff_int8.xml
camera_matrix: [1234.567, 0.0, 640.0, 0.0, 1234.567, 360.0, 0.0, 0.0, 1.0]
distort_coeffs: [0.1, -0.2, 0.0, 0.0, 0.0]

# 检测参数
use_traditional: true
traditional_threshold: 100
min_confidence: 0.8
nms_threshold: 0.5

# 偏移校准
yaw_offset: -0.8
pitch_offset: -1.0

# 控制参数
decision_speed: 10.0
fire_gap_time: 0.1
predict_time: 0.1
```

### 8.2 滤波器参数
```cpp
// 小符参数
Q_small = diag([0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1])
R_small = diag([0.05, 0.05, 0.05, 0.05])

// 大符参数
Q_big = diag([0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1])
R_big = diag([0.05, 0.05, 0.05, 0.05])
```

## 9. 系统优势

### 9.1 技术创新
1. **双模态融合**: 结合深度学习与传统方法，兼顾精度与鲁棒性
2. **自适应滤波**: 使用NIS/NEES检测实现噪声自适应调节
3. **多模型预测**: 针对不同符型采用专门的运动模型
4. **迭代瞄准**: 考虑弹道飞行时间，实现高精度预测打击

### 9.2 性能优势
1. **实时性**: 支持60+ FPS实时处理
2. **高精度**: 角度控制精度达到±0.01rad
3. **鲁棒性**: 能够处理复杂环境和异常情况
4. **可扩展**: 模块化设计便于功能扩展和维护

### 9.3 应用价值
该系统不仅适用于RoboMaster竞赛，还可推广到：
- 工业自动化视觉检测
- 安防监控目标跟踪
- 无人机自主导航
- 智能交通系统

## 10. 未来发展方向

### 10.1 算法优化
- 引入图神经网络处理时序关系
- 使用强化学习优化射击决策
- 集成多目标跟踪算法

### 10.2 硬件优化
- 支持GPU加速计算
- 集成FPGA硬件逻辑
- 优化嵌入式平台性能

### 10.3 系统集成
- 云端协同处理架构
- 多机器人协同作战
- 边缘计算部署方案

---

**技术文档版本**: v1.0
**最后更新**: 2024年11月
**开发团队**: 哨兵机器人视觉组